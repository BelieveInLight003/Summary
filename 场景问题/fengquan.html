<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mapbox 台风风圈</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.3/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.3/mapbox-gl.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      // 公共 Token（免费）
      mapboxgl.accessToken =
        'pk.eyJ1Ijoib2JpZWx1Ym93aXR6IiwiYSI6ImNtYWRjZ2M1bDBjbmsyaXNlbXQwem45engifQ.37niiWt80Yrjg2zt_cjHpA';

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v10',
        center: [120, 25],
        zoom: 4,
      });

      // 模拟台风路径
      const typhoon = {
        tfbh: '2025-16',
        points: [
          // {
          //   lng: 120.5,
          //   lat: 22.3,
          //   radius7: { ne: 300, nw: 180, sw: 160, se: 90 },
          //   radius10: { ne: 120, nw: 100, sw: 90, se: 110 },
          //   radius12: { ne: 60, nw: 50, sw: 40, se: 55 },
          // },
          {
            lng: 121.8,
            lat: 23.9,
            radius7: { ne: 220, nw: 200, sw: 180, se: 210 },
            radius10: { ne: 140, nw: 120, sw: 110, se: 130 },
            radius12: { ne: 80, nw: 70, sw: 60, se: 75 },
          },
        ],
      };

      map.on('load', () => addTyphoonWindCircle(typhoon));

      function addTyphoonWindCircle(data) {
        const features = [];
        data.points.forEach((p, idx) => {
          ['radius7', 'radius10', 'radius12'].forEach((lv) => {
            const coords = getEllipseCoords([p.lng, p.lat], p[lv]);
            features.push({
              type: 'Feature',
              geometry: { type: 'Polygon', coordinates: coords },
              properties: { level: lv, index: idx },
            });
          });
        });

        const sourceId = `typhoon-${data.tfbh}`;
        map.addSource(sourceId, {
          type: 'geojson',
          data: { type: 'FeatureCollection', features },
        });

        map.addLayer({
          id: `${sourceId}-fill`,
          type: 'fill',
          source: sourceId,
          paint: {
            'fill-color': [
              'match',
              ['get', 'level'],
              'radius7',
              '#00ffff',
              'radius10',
              '#ffff00',
              '#ff4444',
            ],
            'fill-opacity': 0.25,
            'fill-outline-color': '#000',
          },
        });
      }

      function getEllipseCoords(center, radiusData) {
        const [cx, cy] = proj4('EPSG:4326', 'EPSG:3857', center);
        const coords = [];
        const step = 6;
        const quad = ['ne', 'nw', 'sw', 'se'];
        for (let i = 0; i < 4; i++) {
          const r_m = (radiusData[quad[i]] || 0) * 1000;
          const start = i * 90;
          const end = (i + 1) * 90;
          for (let a = start; a <= end; a += step) {
            const ang = (a * Math.PI) / 180;
            const x = cx + r_m * Math.cos(ang);
            const y = cy + r_m * Math.sin(ang);
            coords.push(proj4('EPSG:3857', 'EPSG:4326', [x, y]));
          }
        }
        coords.push(coords[0]);
        return [coords];
      }
    </script>
  </body>
</html>
